<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gen</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f4f4; /* สีพื้นหลังโหมดสว่าง */
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            transition: background-color 0.5s;
        }
        .dark-mode {
            background-color: #333; /* สีพื้นหลังโหมดมืด */
            color: #fff; /* สีข้อความในโหมดมืด */
        }
        .chat-container {
            width: 100%;
            height: 90%;
            max-width: 1500px;
            margin: auto;
            background: #fff; /* สีพื้นหลังสำหรับกล่องสนทนา */
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            transition: background 0.5s;
        }
        .dark-mode .chat-container {
            background: #444; /* สีพื้นหลังสำหรับกล่องสนทนาในโหมดมืด */
        }
        .model-select {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 15px;
            border-radius: 5px; /* ปรับขอบมนให้เข้ากับปุ่มอื่น */
            border: 1px solid #000; /* เปลี่ยนสีฟ้าเป็นสีดำ */
            cursor: pointer;
            background: #fff;
            user-select: none;
            transition: background 0.3s ease;
        }
        .model-select:hover {
            background: #D7D7D8;
        }
        .dark-mode .model-select {
            background: #555;
        }
        .new-chat-button {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid #000; /* เปลี่ยนสีฟ้าเป็นสีดำ */
            cursor: pointer;
            background: #fff;
            user-select: none;
            transition: background 0.3s ease, transform 0.5s ease;
            display: flex;
            align-items: center;
        }
        .new-chat-button:active {
            transform: scale(1.15);
        }
        .new-chat-button img {
            width: 20px;
            height: auto;
            margin-right: 5px;
        }
        .dark-mode .new-chat-button {
            background: #555;
        }
        .model-select.active {
            background: #e0e0e0;
        }
        .model-options {
            display: none;
            position: absolute;
            top: 35px;
            left: 35px;
            background: #fff;
            border: 1px solid #000; /* เปลี่ยนสีฟ้าเป็นสีดำ */
            border-radius: 5px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .dark-mode .model-options {
            background: #555;
            border: 1px solid #000; /* เปลี่ยนสีฟ้าเป็นสีดำ */
        }
        .model-options.show {
            display: block;
        }
        .model-options select {
            border: none;
            background: transparent;
            padding: 10px;
            width: 100%;
            appearance: none;
            font-size: 16px;
            cursor: pointer;
        }
        .dark-mode .model-options select {
            color: #fff;
        }
        .model-options select:focus {
            outline: none;
        }
        .model-select-canvas {
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 1px solid #000; /* เปลี่ยนสีฟ้าเป็นสีดำ */
            border-radius: 5px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .model-select-canvas.show {
            transform: scale(1);
            opacity: 1;
        }
        .model-select-canvas.hide {
            transform: scale(0);
            opacity: 0;
        }
        .dark-mode .model-select-canvas {
            background: #555;
        }
        .model-option {
            position: relative;
            padding: 10px;
            cursor: pointer;
            border: 1px solid #000; /* เพิ่มขอบให้ text model */
            margin-bottom: 5px;
        }
        .model-option img {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }
        .model-option.selected img {
            display: block;
        }
        .chat-box {
            padding: 10px;
            height: calc(100% - 150px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-top: 50px;
        }
        .user-input {
            display: flex;
            align-items: center;
            border-top: 1px solid #e9e9e9;
            padding: 10px;
            background: #e9e9e9;
            height: 60px;
        }
        .dark-mode .user-input {
            background: #555;
        }
        .user-input textarea {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px; /* เพิ่มขอบมน */
            font-size: 16px;
            margin-right: 12px;
            resize: none;
            height: 40px;
            text-align: left;
            animation: typing-text 0.5s ease;
            color: #000;
        }
        .dark-mode .user-input textarea {
            color: #fff;
            background: #333;
        }
        @keyframes typing-text {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }
        /* เปลี่ยนชื่อ keyframes สำหรับ indicator */
        @keyframes typing-indicator {
            0% { content: "กำลังคิด..."; }
            25% { content: "กำลังคิด.."; }
            50% { content: "กำลังคิด."; }
            75% { content: "กำลังคิด.."; }
            100% { content: "กำลังคิด..."; }
        }
        .user-input button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease;
            user-select: none;
            background: none; /* ไม่มีสีพื้นหลัง */
        }
        .user-input button:hover {
            background: none;
            transform: scale(1.1);
        }
        .dark-mode .user-input button {
            color: #fff; /* รักษาสีข้อความในโหมดมืด */
        }
        .user-input button.loading img {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .user-input button img {
            width: 32px; /* เพิ่มขนาดเป็น 32px */
            height: auto;
        }
        .message {
            margin: 10px 0;
            opacity: 1;
            transition: opacity 0.5s ease;
            display: flex;
            align-items: center;
        }
        .message.hide {
            opacity: 0;
        }
        .bot-message {
            animation: textAppear 122ms steps(5, end) forwards;
        }
        @keyframes textAppear {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        .user-message {
            justify-content: flex-end;
        }
        .bot-message {
            color: #000000; /* สีข้อความของ AI ในโหมดสว่าง */
        }
        .dark-mode .bot-message {
            color: #ffffff; /* สีข้อความของ AI ในโหมดมืด */
        }
        .icon {
            width: 20px;
            height: auto;
            margin-right: 5px;
        }
        .user-message .icon {
            margin-left: 5px;
            margin-right: 0;
            order: 1; /* เปลี่ยนตำแหน่ง icon ของ user ไปด้านขวา */
        }
        .user-message .message-content {
            order: 0; /* ข้อความของ user อยู่ด้านซ้ายของ icon */
        }
        .bot-message .icon {
            margin-right: 5px;
        }
        .typing-indicator {
            display: inline-block;
            animation: typing-indicator 1.5s steps(5, end) infinite;
        }
        canvas {
            margin-top: 10px;
            border: 1px solid #ccc;
            display: none;
        }
        .tab {
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            padding: 10px;
            background: #e9e9e9;
        }
        .dark-mode .tab {
            background: #555;
        }
        .tab.active {
            font-weight: bold;
            background: #d3d3d3;
        }
        .mode-toggle {
            display: none; /* ซ่อนปุ่มปรับ brightness darkness */
        }
        .code-canvas {
            margin-top: 10px;
            border: 1px solid #ccc;
            display: none;
            width: 100%;
            height: auto;
        }
        /* CSS สำหรับ markdown code block */
        .markdown-code {
            background: #f4f4f4;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-family: monospace;
            margin: 10px 0;
        }
        .dark-mode .markdown-code {
            background: #333;
            color: #fff;
            border-color: #444;
        }
        .copy-button {
            background: none;
            border: none;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .copy-button img {
            width: 20px;
            height: auto;
        }
        .canvas-container {
            position: relative;
        }
        .canvas-copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
        }
        .canvas-copy-button img {
            width: 20px;
            height: auto;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

<div class="chat-container">
    <button class="new-chat-button" onclick="newChat()">
        <img src="https://cdn-icons-png.flaticon.com/128/1159/1159633.png" alt="New Chat Icon" />
        New Chat
    </button>
    <div class="model-select" id="model-selector" onclick="toggleModelSelect()">
        Gen
    </div>
    <canvas id="model-select-canvas" class="model-select-canvas" width="200" height="100"></canvas>
    <div class="model-options" id="model-options">
        <select onchange="selectModel()">
            <option value="typhoon-v1.5-instruct">v1.5-instruct</option>
            <option value="typhoon-v1.5-instruct-fc">v1.5-instruct-fc</option>
        </select>
    </div>
    <div class="chat-box" id="chat-box"></div>
    <div class="user-input">
        <textarea id="user-message" placeholder="พิมพ์ข้อความที่นี่..." onkeypress="checkEnter(event)"></textarea>
        <button id="send-button" onclick="sendMessage()">
            <img src="https://cdn-icons-png.flaticon.com/128/318/318476.png" alt="Send Icon" />
        </button>
    </div>
    <div class="tab" onclick="toggleCodeTab()">แสดงโค้ด</div>
    <div class="canvas-container">
        <canvas id="codeCanvas" class="code-canvas" width="580" height="300"></canvas>
        <button class="canvas-copy-button" onclick="copyCanvasCode()">
            <img src="https://cdn-icons-png.flaticon.com/128/1621/1621635.png" alt="Copy Icon" />
        </button>
    </div>
    <img id="selected-icon" src="https://cdn-icons-png.flaticon.com/128/9554/9554273.png" style="display:none;" />
</div>

<script>
    let typingIndicator;
    let codeVisible = false;
    let darkMode = false; // สถานะของโหมดมืด
    let messageHistory = []; // เก็บประวัติข้อความ

    // ฟังก์ชันสำหรับเปิด/ปิดการเลือก Model
    function toggleModelSelect() {
        const canvas = document.getElementById('model-select-canvas');
        const ctx = canvas.getContext('2d');
        const selectedModel = document.querySelector('#model-options select').value;
        if (canvas.style.display === 'none' || canvas.style.display === '') {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#000";
            ctx.font = "16px Arial";
            ctx.strokeStyle = "#000"; /* เพิ่มขอบสีดำ */
            ctx.strokeText("v1.5-instruct", 40, 30);
            ctx.strokeText("v1.5-instruct-fc", 40, 70);
            if (selectedModel === 'typhoon-v1.5-instruct') {
                ctx.drawImage(document.getElementById('selected-icon'), 10, 15, 20, 20);
            } else if (selectedModel === 'typhoon-v1.5-instruct-fc') {
                ctx.drawImage(document.getElementById('selected-icon'), 10, 55, 20, 20);
            }
            canvas.style.display = 'block';
            canvas.removeEventListener('click', selectModelFromCanvas);
            canvas.addEventListener('click', selectModelFromCanvas);
        } else {
            canvas.style.display = 'none';
            canvas.removeEventListener('click', selectModelFromCanvas);
        }
    }

    // ฟังก์ชันสำหรับเลือก Model จาก Canvas
    function selectModelFromCanvas(event) {
        const canvas = document.getElementById('model-select-canvas');
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#000";
        ctx.font = "16px Arial";
        if (y > 10 && y < 40) {
            ctx.drawImage(document.getElementById('selected-icon'), 10, 15, 20, 20);
            ctx.fillText("v1.5-instruct", 40, 30);
            ctx.fillText("v1.5-instruct-fc", 40, 70);
            document.querySelector('#model-options select').value = 'typhoon-v1.5-instruct';
        } else if (y > 50 && y < 80) {
            ctx.drawImage(document.getElementById('selected-icon'), 10, 55, 20, 20);
            ctx.fillText("v1.5-instruct", 40, 30);
            ctx.fillText("v1.5-instruct-fc", 40, 70);
            document.querySelector('#model-options select').value = 'typhoon-v1.5-instruct-fc';
        }
    }

    // ฟังก์ชันสำหรับส่งข้อความ
    async function sendMessage() {
        const userMessage = document.getElementById('user-message').value.trim();
        if (!userMessage) return;

        displayMessage(userMessage, 'user');
        document.getElementById('user-message').value = '';

        messageHistory.push({ role: 'user', content: userMessage }); // เก็บข้อความในประวัติ

        const sendButton = document.getElementById('send-button');
        const sendIcon = sendButton.querySelector('img');
        sendButton.classList.add('loading');
        sendIcon.src = 'https://cdn-icons-png.flaticon.com/128/7794/7794282.png';

        displayTypingIndicator();

        try {
            const model = document.querySelector('#model-options select').value;
            const endpoint = 'https://api.opentyphoon.ai/v1/chat/completions';
            const headers = {
                Authorization: 'Bearer sk-frn8Q6cNenIlNT0oSmOJ1HVnSIrnjB3c6XKv12xeoSMNFx45'
            };
            const data = {
                model: model,
                max_tokens: 512,
                messages: [
                    { role: "system", content: model === 'typhoon-v1.5-instruct-fc' ? "You are a helpful assistant named ArtX." : "You are Gen, a large language model trained by SCB And Padlojh. Your goal is to assist with helpful, informative, and friendly responses. Always adapt to the user's tone, be conversational, and provide clear and concise answers. Avoid giving medical, legal, or financial advice." },
                    ...messageHistory // ส่งประวัติข้อความไปด้วย
                ],
                temperature: model === 'typhoon-v1.5-instruct-fc' ? 0.2 : 0.4,
                top_p: 0.9,
                top_k: 0,
                repetition_penalty: model === 'typhoon-v1.5-instruct-fc' ? 1.1 : 1.05,
                min_p: 0.05
            };

            const response = await axios.post(endpoint, data, { headers });
            const botResponse = response.data.choices[0].message.content;
            displayMessage(botResponse, 'bot');
            messageHistory.push({ role: 'bot', content: botResponse }); // เก็บข้อความในประวัติ
            resetScroll();
        } catch (error) {
            console.error('Error fetching data from Chatai:', error);
            if (error.response) {
                console.error('Response data:', error.response.data);
                if (error.response.status === 400 && error.response.data.detail === 'Model not found') {
                    displayMessage('ขอโทษ, ยังไม่เปิดให้ใช้งาน.', 'bot');
                } else {
                    displayMessage('ขอโทษ, ข้อความของคุณไม่ถูกต้องหรือไม่สามารถประมวลผลได้.', 'bot');
                }
            } else {
                displayMessage('ขอโทษ, เกิดข้อผิดพลาดในการส่งข้อความ.', 'bot');
            }
        } finally {
            sendButton.classList.remove('loading');
            sendIcon.src = 'https://cdn-icons-png.flaticon.com/128/318/318476.png';
            hideTypingIndicator();
        }
    }

    // ฟังก์ชันสำหรับเลือก Model
    function selectModel() {
        const selectedModel = document.querySelector('#model-options select').value;
        console.log("Selected model: " + selectedModel);
        toggleModelSelect();
    }

    // ฟังก์ชันสำหรับตรวจสอบว่าเป็นโค้ดหรือไม่
    function isCode(response) {
        return response.includes('```');
    }

    // ฟังก์ชันสำหรับแสดงโค้ดด้วย markdown (ลบ icon และ footer เดิม)
    function displayCode(codeContent) {
        const chatBox = document.getElementById('chat-box');
        const codeDiv = document.createElement('div');
        codeDiv.className = 'message bot-message';
        
        const pre = document.createElement('pre');
        pre.className = 'markdown-code';
        const codeElement = document.createElement('code');
        // ใช้ textContent เพื่อรักษารูปแบบและไม่ให้ render HTML ภายใน
        codeElement.textContent = codeContent;
        
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/128/1621/1621635.png" alt="Copy Icon" />';
        copyButton.onclick = () => copyToClipboard(codeContent);

        pre.appendChild(codeElement);
        codeDiv.appendChild(pre);
        codeDiv.appendChild(copyButton);
        chatBox.appendChild(codeDiv);
    }

    // ฟังก์ชันสำหรับคัดลอกโค้ดไปยังคลิปบอร์ด
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('คัดลอกโค้ดเรียบร้อยแล้ว');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    }

    // ฟังก์ชันสำหรับเปิด/ปิดการแสดงโค้ด (สำหรับ canvas ด้านล่าง)
    function toggleCodeTab() {
        codeVisible = !codeVisible;
        const canvas = document.getElementById('codeCanvas');
        canvas.style.display = codeVisible ? 'block' : 'none';
    }

    // ฟังก์ชันสำหรับคัดลอกโค้ดจาก canvas ไปยังคลิปบอร์ด
    function copyCanvasCode() {
        const canvas = document.getElementById('codeCanvas');
        const ctx = canvas.getContext('2d');
        const codeContent = ctx.getImageData(0, 0, canvas.width, canvas.height);
        navigator.clipboard.writeText(codeContent).then(() => {
            alert('คัดลอกโค้ดจาก canvas เรียบร้อยแล้ว');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    }

    // ฟังก์ชันสำหรับตรวจสอบการกด Enter
    function checkEnter(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            sendMessage();
            event.preventDefault();
        }
    }

    // ฟังก์ชันสำหรับแสดง Indicator การพิมพ์
    function displayTypingIndicator() {
        typingIndicator = document.createElement('div');
        typingIndicator.className = 'message bot-message typing-indicator';
        typingIndicator.innerHTML = '<span>กำลังคิด...</span>';
        document.getElementById('chat-box').appendChild(typingIndicator);
        
        setTimeout(() => {
            typingIndicator.style.opacity = 1;
        }, 10);
    }

    // ฟังก์ชันสำหรับซ่อน Indicator การพิมพ์
    function hideTypingIndicator() {
        if (typingIndicator) {
            typingIndicator.style.opacity = 0;
            setTimeout(() => {
                typingIndicator.remove();
            }, 500);
        }
    }

    // ฟังก์ชันสำหรับแสดงข้อความ
    function displayMessage(message, sender) {
        const chatBox = document.getElementById('chat-box');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;

        const icon = sender === 'user'
            ? '<img class="icon" src="https://i.postimg.cc/yNP1Z2wS/user.jpg" alt="User Icon" />' 
            : '<img class="icon" src="https://cdn-icons-png.flaticon.com/128/1694/1694153.png" alt="Chatai Icon" />';

        const emoji = '😊'; 
        const formattedMessage = message.replace(/\n/g, '<br>'); // แปลงการขึ้นบรรทัดใหม่เป็น <br>
        
        if (isCode(message)) {
            // ดึงเฉพาะเนื้อหาของโค้ดที่อยู่ภายใน ``` ```
            const match = message.match(/```([\s\S]*?)```/);
            if (match) {
                const codeContent = match[1];
                // ดึงข้อความที่ไม่ใช่โค้ด (ถ้ามี)
                const textContent = message.split(/```[\s\S]*?```/)[0].trim();
                if (textContent) {
                    messageDiv.innerHTML = `<div class="message-content">${textContent} ${emoji}</div>` + icon;
                    chatBox.appendChild(messageDiv);
                }
                displayCode(codeContent);
            }
        } else {
            if (sender === 'user') {
                messageDiv.innerHTML = `<div class="message-content">${formattedMessage}</div>` + icon; 
            } else {
                messageDiv.innerHTML = icon + `<div class="message-content">${formattedMessage} ${emoji}</div>`; 
            }
            chatBox.appendChild(messageDiv);
        }
        
        setTimeout(() => { 
            messageDiv.style.opacity = 1;
        }, 10);
    }

    // ฟังก์ชันสำหรับรีเซ็ตการเลื่อน
    function resetScroll() {
        const chatBox = document.getElementById('chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ฟังก์ชันสำหรับเปิด/ปิดโหมดมืด
    function toggleMode() {
        darkMode = !darkMode;
        const body = document.body;
        const modeIcon = document.getElementById('mode-icon');

        if (darkMode) {
            body.classList.add('dark-mode');
            modeIcon.src = 'https://cdn-icons-png.flaticon.com/128/12301/12301305.png'; 
        } else {
            body.classList.remove('dark-mode');
            modeIcon.src = 'https://cdn-icons-png.flaticon.com/128/1687/1687788.png'; 
        }
    }

    // ฟังก์ชันสำหรับเริ่มการสนทนาใหม่
    function newChat() {
        const messages = document.querySelectorAll('.message');
        messages.forEach(message => {
            message.classList.add('hide');
        });
        setTimeout(() => {
            document.getElementById('chat-box').innerHTML = '';
            messageHistory = []; // รีเซ็ตประวัติข้อความ
        }, 500);
    }
</script>

</body>
</html>
